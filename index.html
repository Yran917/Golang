<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级五子棋 - 竞技版</title>
    <style>
        :root {
            --board-color: #E6B37E;
            --line-color: #333;
            --primary-blue: #2196F3;
            --danger-red: #F44336;
            --accent-orange: #FF9800;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
        }

        /* 游戏容器 */
        #game-wrapper {
            width: 100%;
            max-width: 500px;
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* 顶部状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #fafafa;
            border-radius: 8px;
        }

        #timer {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--accent-orange);
            font-weight: bold;
        }

        #msg {
            font-weight: bold;
            font-size: 1.1rem;
            color: #444;
        }

        /* 棋盘 */
        #board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            aspect-ratio: 1/1;
            background-color: var(--board-color);
            border: 2px solid var(--line-color);
            position: relative;
            cursor: pointer;
        }

        .cell {
            border: 0.5px solid var(--line-color);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* 棋子样式 */
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .black { background: radial-gradient(circle at 30% 30%, #666, #000); }
        .white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); border: 1px solid #999; }

        /* 最新落子标记 */
        .last-mark::after {
            content: "";
            width: 6px;
            height: 6px;
            background: #ff0000;
            border-radius: 50%;
            position: absolute;
            z-index: 3;
        }

        /* 控制按钮 */
        .controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-main { background: var(--primary-blue); color: white; }
        .btn-undo { background: var(--accent-orange); color: white; }
        .btn-exit { background: var(--danger-red); color: white; }
        button:disabled { background: #ccc; opacity: 0.7; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="status-bar">
        <div id="msg">请选择对战模式</div>
        <div id="timer">00:00</div>
    </div>

    <div id="board"></div>

    <div class="controls">
        <div id="menu-view" class="btn-group">
            <button class="btn-main" onclick="initGame('PVP')">人人对战</button>
            <button class="btn-main" onclick="showAILevels()">人机对战</button>
        </div>

        <div id="ai-view" class="btn-group hidden">
            <button onclick="initGame('PVE', 1)">简单</button>
            <button onclick="initGame('PVE', 2)">一般</button>
            <button onclick="initGame('PVE', 3)">困难</button>
            <button onclick="backToMenu()">返回</button>
        </div>

        <div id="play-view" class="btn-group hidden">
            <button class="btn-undo" id="undoBtn" onclick="undo()">悔棋</button>
            <button class="btn-exit" onclick="confirmExit()">退出当前对局</button>
        </div>
    </div>
</div>

<script>
    const SIZE = 15;
    let board = [];
    let history = [];
    let curPlayer = 1; // 1黑, 2白
    let gameActive = false;
    let mode = 'PVP'; // PVP, PVE
    let level = 1;
    let timeSec = 0;
    let timerId = null;

    // 初始化棋盘UI
    const boardEl = document.getElementById('board');
    for (let i = 0; i < SIZE * SIZE; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.onclick = () => handleTap(i);
        boardEl.appendChild(cell);
    }

    function showAILevels() {
        document.getElementById('menu-view').classList.add('hidden');
        document.getElementById('ai-view').classList.remove('hidden');
    }

    function backToMenu() {
        document.getElementById('ai-view').classList.add('hidden');
        document.getElementById('menu-view').classList.remove('hidden');
    }

    function initGame(m, l = 1) {
        mode = m;
        level = l;
        board = Array(SIZE * SIZE).fill(0);
        history = [];
        curPlayer = 1;
        gameActive = true;
        timeSec = 0;
        
        document.getElementById('menu-view').classList.add('hidden');
        document.getElementById('ai-view').classList.add('hidden');
        document.getElementById('play-view').classList.remove('hidden');
        
        resetUI();
        startTimer();
        updateMsg("黑方落子");
    }

    function handleTap(idx) {
        if (!gameActive || board[idx] !== 0) return;
        placePiece(idx);
        
        if (gameActive && mode === 'PVE' && curPlayer === 2) {
            setTimeout(aiMove, 300);
        }
    }

    function placePiece(idx) {
        board[idx] = curPlayer;
        history.push(idx);
        updateUI();

        if (checkWin(idx)) {
            gameActive = false;
            stopTimer();
            updateMsg((curPlayer === 1 ? "黑方" : "白方") + "获胜！");
            return;
        }

        curPlayer = 3 - curPlayer;
        updateMsg(curPlayer === 1 ? "黑方落子" : "白方落子");
        document.getElementById('undoBtn').disabled = false;
    }

    function checkWin(idx) {
        const r = Math.floor(idx / SIZE);
        const c = idx % SIZE;
        const color = board[idx];
        const dirs = [[1,0], [0,1], [1,1], [1,-1]];

        for (let [dr, dc] of dirs) {
            let count = 1;
            for (let s of [1, -1]) {
                let currR = r + dr * s, currC = c + dc * s;
                while (currR >= 0 && currR < SIZE && currC >= 0 && currC < SIZE && board[currR * SIZE + currC] === color) {
                    count++;
                    currR += dr * s;
                    currC += dc * s;
                }
            }
            if (count >= 5) return true;
        }
        return false;
    }

    function aiMove() {
        if (!gameActive) return;
        let bestIdx = -1;
        
        if (level === 1) {
            // 简单：随机
            let empties = board.map((v, i) => v === 0 ? i : -1).filter(v => v !== -1);
            bestIdx = empties[Math.floor(Math.random() * empties.length)];
        } else {
            // 一般和困难：基于启发式评分
            bestIdx = getBestMove(level === 3);
        }
        
        if (bestIdx !== -1) placePiece(bestIdx);
    }

    function getBestMove(isHard) {
        let maxScore = -1;
        let moves = [];
        
        for (let i = 0; i < board.length; i++) {
            if (board[i] !== 0) continue;
            let score = evaluate(i, 2) + evaluate(i, 1) * (isHard ? 1.1 : 0.8);
            if (score > maxScore) {
                maxScore = score;
                moves = [i];
            } else if (score === maxScore) {
                moves.push(i);
            }
        }
        return moves[Math.floor(Math.random() * moves.length)];
    }

    function evaluate(idx, color) {
        const r = Math.floor(idx / SIZE), c = idx % SIZE;
        let totalScore = 0;
        const dirs = [[1,0], [0,1], [1,1], [1,-1]];

        for (let [dr, dc] of dirs) {
            let line = 1;
            let block = 0;
            for (let s of [1, -1]) {
                let currR = r + dr * s, currC = c + dc * s;
                if (currR < 0 || currR >= SIZE || currC < 0 || currC >= SIZE || board[currR * SIZE + currC] === 3 - color) {
                    block++;
                } else {
                    while (currR >= 0 && currR < SIZE && currC >= 0 && currC < SIZE && board[currR * SIZE + currC] === color) {
                        line++;
                        currR += dr * s;
                        currC += dc * s;
                    }
                    if (currR < 0 || currR >= SIZE || currC < 0 || currC >= SIZE || board[currR * SIZE + currC] === 3 - color) block++;
                }
            }
            // 评分规则
            if (line >= 5) totalScore += 100000;
            else if (line === 4) totalScore += (block === 0 ? 10000 : 1000);
            else if (line === 3) totalScore += (block === 0 ? 1000 : 100);
            else if (line === 2) totalScore += (block === 0 ? 100 : 10);
        }
        return totalScore;
    }

    function undo() {
        if (history.length === 0) return;
        // 人机模式撤回两步，人人模式撤回一步
        let steps = (mode === 'PVE' && history.length >= 2) ? 2 : 1;
        while(steps--) {
            let last = history.pop();
            board[last] = 0;
        }
        curPlayer = history.length % 2 === 0 ? 1 : 2;
        updateUI();
        updateMsg(curPlayer === 1 ? "黑方落子" : "白方落子");
        gameActive = true;
    }

    function confirmExit() {
        if (confirm("确定退出当前对局吗？进度将丢失。")) {
            gameActive = false;
            stopTimer();
            backToMenu();
            document.getElementById('play-view').classList.add('hidden');
            document.getElementById('menu-view').classList.remove('hidden');
            board = Array(SIZE * SIZE).fill(0);
            resetUI();
            updateMsg("请选择对战模式");
            timerDisplay("00:00");
        }
    }

    function updateUI() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach((cell, i) => {
            cell.innerHTML = '';
            cell.classList.remove('last-mark');
            if (board[i] !== 0) {
                const p = document.createElement('div');
                p.className = 'piece ' + (board[i] === 1 ? 'black' : 'white');
                cell.appendChild(p);
            }
        });
        if (history.length > 0) {
            cells[history[history.length - 1]].classList.add('last-mark');
        }
    }

    function resetUI() {
        document.querySelectorAll('.cell').forEach(c => {
            c.innerHTML = '';
            c.classList.remove('last-mark');
        });
    }

    function updateMsg(s) { document.getElementById('msg').innerText = s; }

    function startTimer() {
        timerId = setInterval(() => {
            timeSec++;
            const m = String(Math.floor(timeSec / 60)).padStart(2, '0');
            const s = String(timeSec % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function stopTimer() { clearInterval(timerId); }
</script>
</body>
</html>